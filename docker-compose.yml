services:
  # -----------------------------
  # Infrastructure Services
  # -----------------------------
  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    networks:
      - fit-network

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092"
      - "9999:9999"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "posture-data:1:1,challenge-events:1:1"
      KAFKA_JMX_OPTS: "-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=kafka -Dcom.sun.management.jmxremote.rmi.port=9999"
      JMX_PORT: 9999
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - zookeeper
    networks:
      - fit-network

  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: leejinjae!kho13241003567
      MYSQL_DATABASE: fit_challenge_db
      MYSQL_USER: user
      MYSQL_PASSWORD: kho13241003567
    ports:
      - "3306:3306"
    volumes:
      - ./mysql-data:/var/lib/mysql
    networks:
      - fit-network
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - fit-network

  # -----------------------------
  # Backend Microservices
  # -----------------------------
  gateway-service:
    build: ./backend/gateway-service
    container_name: gateway-service
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_ENABLED=false # Using manual routing or direct for simplicity first
    depends_on:
      - mysql
      - kafka
      - redis
    networks:
      - fit-network

  auth-service:
    build: ./backend/auth-service
    container_name: auth-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/fit_challenge_db?useSSL=false&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=password
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - mysql
      - kafka
    networks:
      - fit-network

  challenge-service:
    build: ./backend/challenge-service
    container_name: challenge-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/fit_challenge_db?useSSL=false&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=password
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - mysql
      - redis
      - kafka
    networks:
      - fit-network

  # -----------------------------
  # AI Service
  # -----------------------------
  ai-service:
    build: ./ai-service
    container_name: ai-service
    ports:
      - "5000:5000"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - REDIS_HOST=redis
    depends_on:
      - kafka
      - redis
    networks:
      - fit-network
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    #     # Note: GPU support requires nvidia-docker installed. 
    #     # If not available, comment out the deploy section or run on CPU.

  # -----------------------------
  # Frontend
  # -----------------------------
  frontend:
    build: ./frontend
    container_name: frontend-app
    ports:
      - "3000:80"
    depends_on:
      - gateway-service
    networks:
      - fit-network

# volumes:
#   mysql-data:

networks:
  fit-network:
    driver: bridge

