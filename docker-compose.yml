services:
  # -----------------------------
  # Infrastructure Services
  # -----------------------------
  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181" # 외부 접속 허용 (선택)
    networks:
      - fit-network

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092" # 로컬 개발용 외부 접속 허용
    environment:
      # 외부(로컬 IDE)에서는 192.168.219.108로 접속
      # 내부(Docker)에서도 이 IP로 접속 가능해야 함
      KAFKA_ADVERTISED_HOST_NAME: 192.168.219.108
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "posture-data:1:1,challenge-events:1:1"
      KAFKA_JMX_OPTS: "-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=192.168.219.108 -Dcom.sun.management.jmxremote.rmi.port=9999"
      JMX_PORT: 9999
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - zookeeper
    networks:
      - fit-network

  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: leejinjae!kho13241003567
      MYSQL_DATABASE: fit_challenge_db
      MYSQL_USER: user
      MYSQL_PASSWORD: kho13241003567
    ports:
      - "3306:3306" # 로컬 개발용 외부 접속 허용
    volumes:
      - ./mysql-data:/var/lib/mysql
    networks:
      - fit-network
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379" # 로컬 개발용 외부 접속 허용
    networks:
      - fit-network

  # -----------------------------
  # Backend Microservices
  # -----------------------------
  gateway-service:
    build: ./backend/gateway-service
    container_name: gateway-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_ENABLED=false
      - AUTH_SERVICE_URL=http://auth-service:8081
      - CHALLENGE_SERVICE_URL=http://challenge-service:8082
      - AI_SERVICE_URL=http://ai-service:5000
    depends_on:
      - mysql
      - kafka
      - redis
    networks:
      - fit-network

  auth-service:
    build: ./backend/auth-service
    container_name: auth-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/fit_challenge_db?useSSL=false&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=kho13241003567
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
      kafka:
        condition: service_started
    networks:
      - fit-network

  challenge-service:
    build: ./backend/challenge-service
    container_name: challenge-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/fit_challenge_db?useSSL=false&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=kho13241003567
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
      kafka:
        condition: service_started
    networks:
      - fit-network

  # -----------------------------
  # AI Service
  # -----------------------------
  ai-service:
    build: ./ai-service
    container_name: ai-service
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - REDIS_HOST=redis
    depends_on:
      - kafka
      - redis
    networks:
      - fit-network
    # deploy: ... (GPU 설정)

  # -----------------------------
  # Frontend
  # -----------------------------
  frontend:
    build: ./frontend
    container_name: frontend-app
    ports:
      - "3000:80"
    depends_on:
      - gateway-service
    networks:
      - fit-network

  # -----------------------------
  # Watchtower (Auto Updater)
  # -----------------------------
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 30 --cleanup
    restart: always
    networks:
      - fit-network

networks:
  fit-network:
    driver: bridge
