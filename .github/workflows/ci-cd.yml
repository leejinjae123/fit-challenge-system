name: Fit Challenge System CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # -----------------------------------------------------------
  # 1. Backend Build & Test (Java/Spring Boot)
  # -----------------------------------------------------------
  backend-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [gateway-service, auth-service, challenge-service]
    
    # Service Containers for Integration Tests
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: fit_challenge_db
          MYSQL_USER: user
          MYSQL_PASSWORD: kho13241003567
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Build and Test ${{ matrix.service }}
      run: |
        cd backend/${{ matrix.service }}
        mvn clean package # Tests will run now

  # -----------------------------------------------------------
  # 2. Frontend Build & Test (React)
  # -----------------------------------------------------------
  frontend-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Dependencies
      run: |
        cd frontend
        npm install
        
    - name: Build Frontend
      run: |
        cd frontend
        npm run build
        
    # - name: Run Tests
    #   run: |
    #     cd frontend
    #     npm test -- --watchAll=false

  # -----------------------------------------------------------
  # 3. AI Service Build & Test (Python)
  # -----------------------------------------------------------
  ai-service-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        cd ai-service
        pip install -r requirements.txt
        
    # - name: Run Linter / Tests
    #   run: |
    #     cd ai-service
    #     # pip install flake8 pytest
    #     # flake8 .
    #     # pytest

  # -----------------------------------------------------------
  # 4. Docker Build & Push (CD)
  # -----------------------------------------------------------
  docker-push:
    needs: [backend-build, frontend-build, ai-service-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Only push on main branch
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ lee }}
        password: ${{ @kho1324 }}
        
    - name: Build and Push Gateway Service
      uses: docker/build-push-action@v4
      with:
        context: ./backend/gateway-service
        push: true
        tags: ${{ lee }}/fit-gateway:latest

    - name: Build and Push Auth Service
      uses: docker/build-push-action@v4
      with:
        context: ./backend/auth-service
        push: true
        tags: ${{ lee }}/fit-auth:latest
        
    - name: Build and Push Challenge Service
      uses: docker/build-push-action@v4
      with:
        context: ./backend/challenge-service
        push: true
        tags: ${{ lee }}/fit-challenge:latest
        
    - name: Build and Push AI Service
      uses: docker/build-push-action@v4
      with:
        context: ./ai-service
        push: true
        tags: ${{ lee }}/fit-ai:latest
        
    - name: Build and Push Frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: ${{ lee }}/fit-frontend:latest

